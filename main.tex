\documentclass[11pt,a4paper]{report}
\usepackage[french]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{layout}
\usepackage{titlesec}
\usepackage{lmodern}
\usepackage{enumitem}
\usepackage{amsmath}
\usepackage{empheq}
\usepackage{amssymb}
\usepackage{mathrsfs}
\usepackage{array}
\usepackage{gensymb}
\usepackage{mathenv}
\usepackage{color, colortbl}
%\usepackage[intlimits]{amsmath}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{listings}
\usepackage{graphicx}
\usepackage{fancybox}
\usepackage{fourier-orns}



\definecolor{codecustom}{rgb}{0,0.5,0}
\definecolor{codegray}{rgb}{0.7,0.7,0.7}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.975,0.97,0.975}
\definecolor{custom}{RGB}{216,0,127}
\definecolor{lightgray}{gray}{0.75}
\definecolor{myblue}{rgb}{.8, .8, 1}
\definecolor{redcustom}{RGB}{255,0,0}

\titleformat{\chapter}[hang]{\bf\huge}{\thechapter}{2pc}{}


\usepackage[final]{pdfpages} %inclure un pdf


  \newcommand*\mybluebox[1]{%
    \colorbox{myblue}{\hspace{0.5em}#1\hspace{1em}}}

\lstdefinestyle{mystyle}{
	language=MATLAB,
    backgroundcolor=\color{backcolour},
    commentstyle=\color{codecustom},
    keywordstyle=\color{custom},
    morekeywords={Fe, Te, sin, carre, Liste, ELEMENT},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\footnotesize,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=t,
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2,
    extendedchars=true,
    literate={ÃÂÃÂ©}{{\'e}}1 {ÃÂÃÂ¡}{{\`e}}1 {ÃÂ}{{\`a }}1 {ÃÂÃÂ§}{{\c{c}}}1 {ÃÂÃÂ}{{\oe}}1 {ÃÂÃÅ}{{\`u}}1
{ÃÂÃÂ}{{\'E}}1 {EÃÂÃÂ}{{\`E}}1 {ÃÂÃÂ}{{\`A}}1 {ÃÂÃÂ}{{\c{C}}}1 {ÃÂÃÂ}{{\OE}}1 {ÃÂÃÂ}{{\^E}}1
{ÃÂÃÂª}{{\^e}}1 {ÃÂÃÂ®}{{\^i}}1 {ÃÂÃÅ}{{\^o}}1 {ÃÂÃÂ»}{{\^u}}1 {ÃÂÃÂ¢}{{\^a}}1,
}

\lstset{style=mystyle}

\frenchbsetup{StandardItemLabels=true, CompactItemize=false, ReduceListSpacing=true}
\setcounter{tocdepth}{4}
\usepackage{caption}
\DeclareCaptionFont{white}{\color{white}}
\DeclareCaptionFormat{listing}{\colorbox{codecustom}{\parbox{\textwidth}{#1#2#3}}}
\captionsetup[lstlisting]{format=listing,labelfont=white,textfont=white}

\renewcommand{\lstlistingname}{Code Extracted}

%%%%%%%% Espace entre paragraphe et Indentation %%%%%%%%%%%%%%%%%%%%

\setlength{\parskip}{0.09cm}
\setlength{\parindent}{0.8cm}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%% Dimensions de la page %%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[top=2cm, bottom=2cm, left=2cm, right=2cm]{geometry}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%% Lien Hyperref Sommainre %%%%%%%%%%%%%%%%%%%%%%%%%%


\usepackage{hyperref} % Créer des liens et des signets

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%% Gestion des en-tête/pieds de page %%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{fancyhdr}
\pagestyle{fancy}

% Permet d'écrire le nom des chapitres et section en minuscules au lieu de majuscules definit par défaut
\renewcommand{\chaptermark}[1]{\markboth{\bsc{\chaptername~\thechapter{} :} #1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection{} #1}}
%

\renewcommand{\headrulewidth}{0.4pt} % epaisseur du trait
\fancyhead[C]{}
\fancyhead[L]{\leftmark}
\fancyhead[R]{Guedira}

\renewcommand{\footrulewidth}{0.4pt}
\fancyfoot[C]{\textbf{Page \thepage}}
%\fancyfoot[L]{}
%\fancyhead[C]{}
\fancyhead[R]{\leftmark}
\fancyhead[L]{}

\renewcommand{\footrulewidth}{0.4pt}
\fancyfoot[C]{\textbf{Page \thepage}}
\fancyfoot[L]{\textsc{Ismail Guedira}}
\fancyfoot[R]{\rightmark}

%%%%%%%%%%%%% Option des annexes %%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage[toc,page]{appendix}
\renewcommand{\appendixtocname}{Annexes}
\renewcommand{\appendixpagename}{Annexes}
\renewcommand{\appendixname}{Annexes}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\gray}{\rowcolor[gray]{.90}}

\usepackage{pifont} %utiliser des signes pour les itemize plutot cool

\usepackage{lscape}	%pouvoir passer en mode paysage



%%%%%%%%%% Change le nom Table en Tableau %%%%%%%%%%

% \addto\captionsfrench{\def\tablename{Tableau}}

%@\addto\captionsfrench{\def\figure{Figure}}

\title{Semester Project -- Bandgap Reference Voltage}
\author{Ismail Guedira}
\usepackage{layout}



\begin{document}


%%%%% %%%%%%%%%                       Et si on refaisait la page de garde            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 \makeatletter
   \begin{titlepage}
  % \centering
    {
    
    
    \Large \textbf{EPFL - Microcity} \hfill \\
    \large \textsc{Rue de la Maladière 71,} \hfill \\ %Rue de la Maladière 71, 2000 Neuchâtel
	  \large \textsc{2000 Neuchatel} \hfill \\
    \large \textsc{SUISSE} \hfill \\ }
    \begin{flushright}
      \includegraphics[height=0.1\textheight]{logo_epfl} 
    \end{flushright}
    
	\hspace{3em}
% 
% 
% \hfill \Large   \textsc{\@author} \hfill \\ 
% \hfill \normalsize \bfseries Exchange Student EPFL \\
% \hfill \normalsize \it Génie Électrique et électronique \\ 
 \vfill
\centering

 
     \hrule
    %  \vspace{2em}
    %  \LARGE \textbf{} \\
     \vspace{2em}
     \huge \textbf{\@title} \\
     \vspace{1em}
     \LARGE \textit{ESPLAB - Electronic and Signal Processing Laboratory}
     \vspace{2em}
     \hrule
    
        
    
%  \hfill   \large $2^{ième}$ Année - \textbf{S}ystèmes \textbf{É}lectroniques \textbf{I}ntégrés \hfill \\
%  \hfill   \textit{ismail.guedira@phelma.grenoble-inp.fr} \hfill \\
% 	\vspace{2em}
% 
%     % \Large \textbf{Maitre de Stage :} 	\hfill	\Large \textsc{Hugo Petit} \\
%    % 										\hfill	\large \textbf{Analog Design Manager} \\
%    % 										\hfill	\textit{hugo.petit.cn@rolls-royce.com} \\
% 
% 
     \vfill
% 
      {\Large \textsc{2014/2015}  \hfill \Large \textsc{\@date}} \\
% 
% 
  \end{titlepage}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\maketitle
\pagenumbering{roman}
\renewcommand{\contentsname}{Sommaire}
\tableofcontents


% \newpage
% \chapter*{Remerciement}
% \addcontentsline{toc}{chapter}{Remerciement}
% 
% REMERCIEMENT
% 
% 
% \chapter*{Introduction}
% \addcontentsline{toc}{chapter}{Introduction}
% 
% INTRODUCTION
% 

\newpage
% 
\addcontentsline{toc}{chapter}{Abstract}
\vspace{3cm}
\textbf{Abstract} \\
\newline
\hspace*{17pt} ABSTRACT

\newpage
\begin{minipage}{\textwidth}
  \listoffigures
  \listoftables
\end{minipage}

\newpage

\pagenumbering{arabic}

\chapter{Principle \& Specifications}

Voltage references have always been an essential component of any system and consequently an important topic to explore. The last decades thrust toward higher and even total system integration has required all designers to be knowledgeable of this particular topic due to its mixed-signal implications (output impedance, temperature coefficient, etc...)


A general-use (ideal) voltage reference is a circuit used to generate a fixed voltage, $V_{ref}$, that is independent of the power supply voltage VDD (where $V_{ref} < VDD$ ), temperature, and process variations. In other words, the ideal reference voltage is independent of PVT. In some cases, we want to design a reference that varies with temperature. For example, if $V_{ref}$ increases with temperature, Fig. \ref{ptat_crb}, we say that the reference voltage is proportional to absolute temperature or \textbf{PTAT}. If the reference voltage decreases with increasing temperature,            Fig. \ref{CTAT_crb}, the reference is said to be complementary to absolute temperature or \textbf{CTAT}. 

\begin{figure}[h!]
   \begin{minipage}[b]{0.5\linewidth}
      \centering \includegraphics[scale=0.4]{photo/CTAT_crb}
      \caption{CTAT Voltage Evolution}
      \label{CTAT_crb}
   \end{minipage}\hfill
   \begin{minipage}[b]{0.5\linewidth}
      \centering \includegraphics[scale=0.4]{photo/PTAT_crb}
      \caption{PTAT Voltage Evolution}
      \label{ptat_crb}
   \end{minipage}
\end{figure}

\newpage

The \textbf{PTAT} and \textbf{CTAT} references can be used to design a voltage reference that changes very little with temperature called a bandgap reference. We only need to sum the two voltages with the correct coefficient K (Fig. \ref{Gene_bandgap}).

\begin{figure}[h!]
   \begin{minipage}[b]{0.5\linewidth}
      \centering \includegraphics[scale=0.35]{photo/schema_principe}
   \end{minipage}\hfill
   \begin{minipage}[b]{0.5\linewidth}
      \centering \includegraphics[scale=0.4]{photo/sum_crb}
   \end{minipage}
   \caption{General Bandgap Voltage Principle}
   \label{Gene_bandgap}
\end{figure}

Now, we need to find the component, or a characteristic that has a PTAT or CTAT behaviour. We are going to use the usual componenent, Bipolar and MOS transistor. In one hand, we can notice that the temperature coefficient of (evolution with respect to Temperature ) $V_{BE}$ is negative, as well as the $V_{GS}$ of a MOS transitor. In the other hand, we can observe that two bipolar or MOS transistor working at a unequal current densities create a voltage that is proportionnal to $U_T = \frac{kT}{q}$ therefore PTAT voltage (Positive Temperature Coefficient - TC).

The bandgap voltage reference will be used in different block, and for applications with low power consumption. The design will then take into account some specifications related to these applications. We can resume the main specifications of this project in the next table :

\begin{table}[h]
  \begin{center}
  \begin{tabular}{|c|c|c|c|} \hline
                                 & Typ & Maximum       & Minimum \\ \hline
    \textbf{Current Consumption} & $1~\mu$A & $3~\mu$A &   ---     \\ \hline
    \textbf{Power Supply Voltage}& 1.8 V    & 2 V      & 1.5 V \\ \hline \hline
    \textbf{Technology}          & \multicolumn{3}{c|}{UMC L180}  \\ \hline
  \end{tabular}
\end{center}
\caption{Voltage Reference Specifications}
\end{table}


\chapter{Generate a CTAT Voltage}
\section{Evolution of $V_{BE}$ with respect to temperature}

The base-emmiter voltage of a bipolar transistors or, more generally, the forward voltage of a pn-junction diode show a negative TC. For a bipolar device such as represented in the Fig. \ref{vbe_T} 

\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.3]{photo/CTAT_VBE}
  \end{center}
  \caption{Base-emitter Voltage Context}
  \label{vbe_T}
\end{figure}

\begin{equation}
  V_{BE} = \frac{k_BT}{q} \cdot ln \left( \frac{I_C}{I_S} \right)
\end{equation}

With $I_S$, the saturation current which depend on the temperature through different characteristic ($n_i$, $\mu_0$) that depend differently of temperature. In a first calculation, we suppose that the collector current $I_C$ is independent of the temperature. After calculation (details on Appendix \ref{}) we obtain : 

\begin{equation}
 \frac{\partial V_{BE}}{\partial T} = \frac{V_{BE} - (4+m)U_T - E_g/q}{T}
 \label{DvbeDT}                        
\end{equation}

Where $m /approx -3/2$ a process parameter, $E_g /approx 1.12 eV $ the bandgap energy of silicon, $U_T = \frac{kT}{q}$ the thermal voltage. 
The equation \ref{DvbeDT}, reveal the dependence of the TC of $V_{BE}$ to the magnitude of $V_{BE}$ itself.
We then fix $V_BE \approx 700 mV $, $T \approx 300 K$ and we obtain $\frac{\partial V_{BE}}{\partial T} \approx -1.2 mV/ K$. In fact, in this part we limit our temperature analysis to the dependence to the first order of temperature which create a second order temperature dependence.


\newpage

\section{Bipolar Implementation in CMOS process}

The implementation of a bipolar transitor in a CMOS process used here process a lateral bipolar transistor which can be better controled and processed with a much better accuracy than the vertical bipolar. In fact, during the process, the depth of oxydation in the silicon is controlled with much more difficulty whereas the oxydation of a specific area is much more controled and processed with a better accuracy. We then use a lateral transistor, processed and layouted as in the Fig \ref{PNPCMOS} : 

\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.5]{photo/PNP_CMOS}
  \end{center}
  \caption{Layout of PNP Bipolar Transitor}
  \label{PNPCMOS}
\end{figure}

\chapter{Generate a PTAT Voltage}
\section{Using Base-emitter Voltage}

As said in the first chapter, we are going to use two bipolar transistor in two different current densities, and then the difference between their base-emitter voltage produce a voltage which is proportionnal to the thermal voltage, we then have a PTAT voltage.

We are going to use two branches with the same current I, and in one branch we are going to use n identical bipolar transitor and one bipolar transistor in the other branch ($I_{S2} = n I_{S}$ and $I_{S1} = I_{S}$).

\begin{align}
  \Delta V_{BE} & = V_{BE1} - V_{BE2} \\
              & = U_T ln \left( \frac{I_0}{I_{S1}}\right) - U_T ln \left( \frac{I_0}{I_{S2}}\right) \\
              & = \frac{kT}{q} \cdot ln(n)
\end{align}

\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.35]{photo/PTAT_1}
  \end{center}
  \caption{Generate a PTAT Voltage}
  \label{PTAT_1}
\end{figure}

\newpage

The precedent structure manipulate a differential voltage, the final idea is to add this voltage to a CTAT voltage which is not possible in a complete structure, so instead of generating a PTAT differential voltage, we generate a PTAT current which we can easily copy in another branch.

\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.35]{photo/PTAT2}
  \end{center}
  \caption{Generate a PTAT Current}
  \label{PTAT_Cur}
\end{figure}

In this structure, we need also use a mechanism that will force $V_{O1} = V_{O2}$, we will use a operational amplifier with a high gain to force the two voltages to be equal.
\begin{align}
  V_{O1} & = V_{O2} \\
  V_{BE1}& = RI + V_{BE2} \\
  I      & = \frac{\Delta V_{BE}}{R} \\
         & = \frac{\frac{kT}{q}\cdot ln(n)}{R}
\end{align}

We obtain finally a PTAT current proportional to the thermal voltage that is easier to sum with a CTAT current or Voltage. Moreover we have two parameter n and R, that we can fix to cancel the negative temperature coefficient.

\section{Using Gate-source Voltage}

We use two transistor M1 and M2, which will operate in weak inversion with two different current densities. This region of operation have quasi the same way of variation than the bipolar transistor, whith a exponential dependence of the drain current with respect to the gate-source voltage.
\begin{align}
  I_{DS} & = I_{SPECs} \cdot \frac{W}{L} \cdot exp\left( q\frac{V_{gs}-V_t}{nkT} \right) \\
  I_{SPECs} & = 2 n \mu_{n} C_{ox} U_t^2
\end{align}

\newpage

In the same way, we use an Opamp to ensure that the two voltages $V_A$ $V_B$ are equal. We use the same current in the two branches, and we size the transistor M2 m times larger than M1, we then have :

\begin{align}
  V_{GS1} = & ~ n U_T \cdot ln\left( \frac{I_{DS1} \cdot L_1}{I_{SPECs} \cdot W_1} + V_{T0} \right) \\ 
  V_{GS2} = & ~ n U_T \cdot ln\left( \frac{I_{DS2} \cdot L_2}{I_{SPECs} \cdot W_2} + V_{T0} \right) \\
  \frac{W_2}{L_2} = & ~ m \cdot \frac{W_1}{L_1}
\end{align}

In the same logic we obtain a current $I_{R1}$ which is proportional to $\Delta V_{GS}$, in fact the final theoritical expression of $I_{R1} = \frac{\Delta V_{GS}}{R_1}$ with :

\begin{equation}
  \Delta V_{GS} = ~n~\frac{kT}{q}ln(m)
\end{equation} 

\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.3]{photo/PTAT_MOS}
  \end{center}
  \caption{Generate a PTAT Current with MOS transistor}
  \label{PTAT_MOS}
\end{figure}

The final result is very similar to the bipolar "version", except that for the MOS version, $\Delta V_{GS}$ is proportionnal to the slope factor, except that this parameter is dependent of the temperature, the variation can be neglected for the dependence of the first order of temperature. 

\chapter{Bandgap Voltage}
\section{Current Source - Beta-Multiplier}

As we are limited to 3 $\mu A$ in current consumption, we are going to limit the current consumption in the current source to the minimum. We decide then to produce a current of 100 nA that we are going to mirror in the different branches to generate a PTAT and a CTAT voltage.
To generate this current, we are going to use the structure in the Fig \ref{beta_m} :

\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.25]{photo/beta_multiplier}
  \end{center}
  \caption{Beta-Multiplier Current Source with Cascode}
  \label{beta_m}
\end{figure}

For such low current, we use the two transistor M1 and M2 in weak inversion, and to obtain a good current mirror with respect to mismatch and have then $I_{ref}$ quasi equal to $I_{out}$ we put the transistor M3 and M4 in strong inversion. We can then used the simplified equation of the drain current in weak inversion, given by the EKV model : 

\begin{equation}
  I_{out} = I_{spec} \cdot exp \left( \frac{V_G - n V_S - V_{T0}}{n U_T}\right)
\end{equation}

If we apply this equation to the transitor M1 and M2, with M2 k times larger than M1, we have the final expression of $I_{out}$ :

\begin{equation}
  I_{out} = I_{ref} = \frac{U_T \cdot ln(k)}{R_S}
\end{equation}

The main problem of this structure is the dependence of the current $I_{out}$ to the absolute value of $R_S$, which make the current depend on process variation. In fact, the absolute value of $R_S$ have a global precision of $\pm 20~\%$.

The other important dependence of $I_{out}$ is to the varation of $V_{DD}$ by $\Delta V_{DD}$. Therefore, we have to do a small signal analysis of the varation $\Delta I_{out}$ of $I_{out}$ with a varation of $V_{DD}$ by $\Delta V_{DD}$. The details of the calculation are shown in the Appendix \ref{deltaiout}, but we have finally :

\begin{equation}
  \frac{\Delta I_{out}}{\Delta V_{DD}} \approx \frac{1}{r_{on}} + \frac{2}{r_{op}}
\end{equation} 

With $r_{on}$ and $r_{op}$ respectively the output resistance of the NMOS and PMOS transistor, as shown in the Appendix \ref{deltaiout} . Therefore, to decrease the dependence of $I_{out}$ to $V_{DD}$, we have to increase $r_{on}$ and $r_{op}$, to do that we are going to use a cascode structure for the NMOS transistor and increase the length of the PMOS transistor to increase $r_{op}$. The final structure is shown on Fig \ref{beta_m_C} :

\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.35]{photo/beta_multiplier_c}
  \end{center}
  \caption{Beta-Multiplier Current Source with Cascode}
  \label{beta_m_C}
\end{figure}

As the transistor M1 and M2 should work on weak inversion we choose an inversion coefficient $IC(M1) = ?????$ and we choose k = 4, so $\frac{W_2}{L_2}~=~4\cdot\frac{W_1}{L_1} $
To maximize the swing we put the voltage $V$
And finally, the transistor M5 and M6, should work on strong inversion, so we choose an inversion coefficient $IC = ?????$ so we can have a very large value of $L_5$ and $L_6$. We have finally : 

\begin{table}[h]
  \begin{center}
  \begin{tabular}{|c|c|}\hline
    $W_1 = 4~\mu m$       & $L_1 = 180~ nm$ \\ \hline
    $W_2 =  16~ \mu m$       & $L_2 = 180~ nm$ \\ \hline
    $W_3 = W_4 = 5~ \mu m$ & $L_3 = L_4 = 250~ nm$  \\ \hline
    $W_5 = W_6 = 250~nm$ & $L_5 = L_6 = 3.2~\mu m$ \\ \hline
  \end{tabular}
\end{center}
\caption{Beta-Multiplier transitor dimension}
\end{table}

\newpage
\section{Single Stage OTA}

The specifications impose us a very low current consumption (max 3 $\mu A$), though the amplifier need to have a very high gain so we can have $V_{O1}$ = $V_{O2}$, Fig. \ref{PTAT_Cur}, and then we need enough current to have enough gain, we decide to fix a gain $A_0 = 500 \approx 50~dB$.

\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.3]{photo/OTA_Pmos}
  \end{center}
  \caption{OTA with PMOS differential pair}
  \label{OTA}
\end{figure}

The transistor m1 and m2 have the same size and the transistor m3 and m4 too.
We choose then a current $I_D(m5)= I_0 = 500~nA$, we have then $I_D(m1,m2,m3,m4)= I_0/2 =250~nA$. We fix also the gain band width (GBW) to 10 kHz and a load capacitance $C_L = 1~pF$. We can use the expression of the unity gain frequency express $g_m(m1,m2)$ :

\begin{equation}
  g_m(m1,m2) = GBW\cdot C_L = 10\cdot10^{-9} \cdot \Omega^{-1}
  \end{equation}   

We have the value of $g_m$ and the current flowing on the transitors m1 and m2 we can now determine their inversion coefficient and then deduce the $\frac{W}{L}$ of the differential pair :

\begin{equation}
  \frac{g_m}{I} = \frac{1}{n U_T} \cdot \frac{2}{ \sqrt{1+4IC} +1 }
\end{equation}
\begin{equation}
  \frac{W}{L}(m1,m2) = \frac{I_0/2}{I_{spec_{\Box}}\cdot IC}
\end{equation}

We know that the output resistance is related to the length of the transistor m1 and m4 due to the channel length modulation,eq. \ref{len}, moreover if we do the small signal analysis we can also link the gain $A_0$ to $R_{out}$, eq \ref{A0}. Finally, to size the NMOS current mirror we fix the overdrive voltage $V_{ov} = 200~mV$ and deduce the W/L thanks to Eq \ref{SI}. 


\begin{equation}
  L(m1,m4) = I_0/2 \cdot R_{out}~\left(\frac{1}{U_{aN}}+\frac{1}{U_{aP}}\right)
  \label{len}
\end{equation}

\begin{equation}
  A_0 = R_{out}\cdot g_m(m1,m2) 
  \label{A0}
\end{equation}

\begin{equation}
  \frac{W}{L}(m3, m4) = \frac{ 2n \cdot I_0/2}{\mu_n C_{ox} V_{ov}^2}
  \label{SI}
\end{equation}

\newpage

The final dimension of the transistors are resumed in the next table :

\begin{table}[h]
  \begin{center}
  \begin{tabular}{|c|c|}\hline
    $W_1 = W_2 = 1.47 ~\mu m$ & $L_1 = L_2 = 5.31 ~\mu m$  \\ \hline
    $W_3 = W_4 = 12.05 ~\mu m$ & $L_3 = L_4 = 5.31 ~\mu m$ \\ \hline
    $W_5 = 1.25 ~ \mu m$       & $L_5 = 3.2~\mu m$ \\ \hline
  \end{tabular}
\end{center}
\caption{OTA transitor dimension}
\end{table}

\section{Overall circuits}
\subsection{Bandgap Voltage Reference}

The final circuits is composed of the PTAT circuits using a current mirror to copy the current in the two branches, these two transistor (M3,M4) are biased thanks to the beta-multiplier current source, in fact in each branch we use a current of 250 nA. The operational amplifier equalize the voltage $V_A$ and $V_B$ and therfore produce a PTAT current. This current is copied in the third branch (right one) and converted to a PTAT voltage thanks to the resistance $R_2$ and then added to the base-emitter voltage of the PNP bipolar transistor. 

\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.5]{photo/bandgap_3pnp}
  \end{center}
  \caption{Bandgap Voltage Reference}
  \label{bandgap_3pnp}
\end{figure}

\begin{equation}
  V_{ref} = V_{BE3} + \frac{R_2}{R_1} \Delta V_{BE} = V_{BE3} + \frac{R_2}{R_1} \cdot \frac{kT}{q}ln(n)
\end{equation}

The final equation to cancel the temperature

\begin{align}
  \frac{\partial V_{ref}}{\partial T} & = \frac{\partial V_{BE3}}{\partial T} + \frac{R_2}{R_1} \cdot \frac{k}{q}ln(n) \\
  \frac{R_2}{R_1}                     & = - ~ \frac{ \frac{\partial V_{BE3}}{\partial T} }{ \frac{k}{q}ln(n) }
\end{align}

\begin{table}[h]
  \begin{center}
  \begin{tabular}{|c|c|}\hline
    $W_3 = W_4 = W_5 = 625 ~nm $ & $L_3 = L_4 = L_5 = 3.2~\mu m$ \\ \hline 
    $R_1 =  \Omega$     & $R_2 = \Omega $  \\ \hline \hline
    \multicolumn{2}{|c|}{n = 4} \\ \hline
  \end{tabular}
\end{center}
  \caption{Bandgap Voltage Reference Dimensions}
\end{table}

The final current consumption is $200~nA + 3\cdot250~nA + 500~nA = 1.450~\mu A $, the final voltage is quasi-independent of the temperature but the current generated on the third branch is PTAT, we have only a bandgap voltage, moreover for low power applications it's very interesting to have a voltage inferior to 1V, as it's usually used in low power device. The cancelation of the two temperature coefficient is done thanks to the quotient of the two resistance, so the cancelation doesn't depend on process varation, in fact if the process create an imprecision of +20 \% on $R_1$,for instance, the resistance $R_2$ is also 20 \% higher than the nominal value.

\subsection{ Sub-1V Bandgap Current and Voltage Reference}

A problem with the bandgap circuits described so far is that they are not compatible with low power applications, that  usually need a reference voltage sub 1V. The fundamental problem is that the previous circuits produce, in series, the CTAT voltage across a pn-junction and a PTAT voltage scaled to provide temperature- independence. Together, these voltages exceed 1 V. The solution is to sum currents: one CPTAT and one PTAT, passing them through a resistor to form a temperature-insensitive reference voltage below 1 V.
A low-voltage bandgap circuit based on this idea is shown in Fig. \ref{bandgap_2pnp}. The feedback loop formed by the amplifier and current mirror Q1 /Q2 ensures that the voltages at the drains of Q1 and Q2 are very well matched and equal to the base-emitter voltage drop across diode D , $V_{BE1}$ , which is inversely proportional to absolute temperature.
 
\begin{figure}[h]
  \begin{center}
    \includegraphics[scale=0.4]{photo/Figure_basique}
  \end{center}
  \caption{Bandgap Voltage and Current Reference}
  \label{bandgap_2pnp}
\end{figure}

The CTAT voltage $V_{BE1}$ and PTAT $\Delta V_{BE}$ are converted into the currents I2a and I2b by the resistors Ra (\ref{ICtat}) and Rb,(\ref{ICtat}) respectively.
These two currents are summed at the drain of Q2 and mirrored to device Q3 . The resulting current then passes back through resistor R to yield the reference output.

\begin{equation}
  I_{2a} = \frac{V_{BE1}}{R_a}
  \label{ICtat}
\end{equation}

\begin{equation}
  I_{2a} = \frac{\Delta V_{BE}}{R_b}
  \label{IPtat}
\end{equation}

%The voltage across Rb is equal to the difference between the forward bias voltages of D1 and D2, ΔVBE, and is therefore PTAT. The current mirror and matched resistors Ra ensure that the current through the diodes differs by the factor M, and that the diode current densities differ by a factor MN .

The values M, N, Ra, and Rb are chosen to ensure that the inverse temperature coefficient of the first term is pre- cisely cancelled by the positive temperature coefficient of the second term. Notice that nowhere are there DC volt- ages exceeding VBE, so this circuit has been used with supply voltages as low as 0.8 V. The values of K and R can be chosen to scale the actual value of the reference potential at Vref, while the values of N, Ra and Rb are chosen to cancel the negative and positive temperature coefficients of the first and second terms in (\ref{finaleqbdgp}).

\begin{equation}
  V_{ref} = V_{BE1} \frac{KR}{R_a} + \frac{kT}{q}ln(N) \frac{KR}{R_b} 
  \label{finaleqbdgp}
\end{equation}

% BILAN


\chapter{Results after Simulation}

\section{Dependence to VDD}

% Beta - multiplier dependence on VDD 

\section{Temperature Dependence}

% Ca marche pas haha

\section{Simulation Post route}


% un CTAT qui marche bien :(

% un PTAT qui marche bien :(

\chapter*{Conclusion}
\addcontentsline{toc}{chapter}{Conclusion}


%%%%%%%%%%%%%%% Début de la gestion de l'annexe %%%%%%%%%%%%%%

\begin{appendices}
\include{Annexe/annexe}
\end{appendices}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\end{document}
